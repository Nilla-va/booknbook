<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cjcs.bnb.dao.MemberDao">



<!-- 킹효진 -->

<!-- 판매자 아이디 불러오기 -->
   <select id="getMemberInfo" resultType="com.cjcs.bnb.dto.MemberDto">
        SELECT m.m_id, m.m_addr, m.m_phone
        FROM Member m
        WHERE m.m_id = #{s_id}
    </select>

<!--재락-->

    <!--회원가입정보 DB에 넣기-->
    <insert id="joinMember" parameterType="MemberDto">
        INSERT INTO M
        VALUES(#{m_id}, #{m_pw}, #{m_addr}, #{m_phone}, #{m_email}, DEFAULT)
    </insert>
    
  <insert id="joinSeller" parameterType="MemberDto">
        INSERT INTO S(s_id, s_storename, s_crn )
        VALUES(#{m_id}, #{s_storename}, #{s_crn})
    </insert>

    <insert id="joinCustomer" parameterType="MemberDto">
        INSERT INTO C(c_id, c_name) 
        VALUES(#{m_id}, #{c_name})
    </insert>

   


<!--예림-->

    <!--id로 판매자회원정보 가져오기-->
    <select id="getSellerInfoById" parameterType="String" resultType="MemberDto">
        <!--DB에 seller_info라는 뷰 미리 만들어놨음-->
        SELECT * FROM SELLER_INFO 
        WHERE M_ID=#{m_id}
    </select>

    <!--판매자회원정보 수정하기-->
    <update id="updateMemberInfo" parameterType="MemberDto">
        UPDATE M 
        <set>
            <if test="m_pw != null">m_pw = #{m_pw},</if>
            <if test="m_addr != null">m_addr = #{m_addr},</if>
            <if test="m_phone != null">m_phone = #{m_phone},</if>
            <if test="m_email != null">m_email = #{m_email},</if>
        </set>
        WHERE M_ID=#{m_id}
    </update>
    <update id="updateSellerInfo" parameterType="MemberDto">
        UPDATE S 
        <set>
            <if test="s_storename != null">s_storename = #{s_storename},</if>
            <if test="s_storedesc != null">s_storedesc = #{s_storedesc},</if>
            <if test="s_crn != null">s_crn = #{s_crn},</if>
            <if test="s_deliveryfee != null">s_deliveryfee = #{s_deliveryfee},</if>
            <if test="s_latefee != null">s_latefee = #{s_latefee}</if>
        </set>
        WHERE S_ID=#{m_id}
    </update>

    <!-- 오늘 즐겨찾기 회원수 카운트 -->
    <select id="getTodayBookmarkCnt" parameterType="SellerDto" resultType="Integer">
        SELECT COUNT(*)
        FROM FavStore
        WHERE FAVS_S_ID = 'seller001' and TRUNC(FAVS_DATE) = TRUNC(SYSDATE)
        <!-- WHERE FAVS_S_ID = #{s_id} and TRUNC(FAVS_DATE) = TRUNC(sysdate) --> 
    </select>

    <!-- 이번주 즐겨잧기 회원수 카운트 -->
    <select id="getWeekBookmarkCnt" parameterType="SellerDto" resultType="Integer">
        SELECT COUNT(*)
        FROM FavStore
        WHERE FAVS_S_ID = 'seller001' and FAVS_DATE >= to_char(sysdate-7, 'yy/mm/dd')
        <!-- WHERE FAVS_S_ID = #{s_id} and FAVS_DATE >= to_char(sysdate-7, 'yy/mm/dd') -->
    </select>

    <!-- 이번달 즐겨잧기 회원수 카운트 -->
    <select id="getMonthBookmarkCnt" parameterType="SellerDto" resultType="Integer">
        SELECT COUNT(*)
        FROM FavStore
        WHERE FAVS_S_ID = 'seller001' and FAVS_DATE >= to_char(sysdate-30, 'yy/mm/dd')
        <!-- WHERE FAVS_S_ID = #{s_id} and FAVS_DATE >= to_char(sysdate-30, 'yy/mm/dd') -->
    </select>

    <!-- 이용 회원 리스트 불러오기 -->
    <select id="getCsMemberList" resultType="MemberDto">
        SELECT 
            o_c_id,
            c_name,
            SUM(CASE WHEN order_sort = '구매' THEN amount ELSE 0 END) AS SELL_AMOUNT,
            SUM(CASE WHEN order_sort = '대여' THEN amount ELSE 0 END) AS RENTAL_AMOUNT,
            COUNT(CASE WHEN r_latefee_total > 0 THEN 1 ELSE NULL END) AS LATE_AMOUNT
        FROM 
            order_list
        INNER JOIN 
            customer ON order_list.o_c_id = customer.c_id
        where
            s_id = 'seller001'
        GROUP BY 
            o_c_id, c_name
    </select>
    




<!--수희-->

    <!--id로 구매자회원정보 가져오기-->
    <select id="getCustomerInfoById" parameterType="String" resultType="MemberDto">
        <!--DB에 customer_info라는 뷰 미리 만들어놨음-->
        SELECT * FROM CUSTOMER_INFO 
        WHERE M_ID=#{m_id}
    </select>

    <!--구매자회원정보 수정하기-->
    <!-- <update id="updateMemberInfo" parameterType="MemberDto">
        UPDATE M 
        <set>
            <if test="m_pw != null">m_pw = #{m_pw},</if>
            <if test="m_addr != null">m_addr = #{m_addr},</if>
            <if test="m_phone != null">m_phone = #{m_phone},</if>
            <if test="m_email != null">m_email = #{m_email},</if>
        </set>
        WHERE M_ID=#{m_id}
    </update> 예림이랑 중복-->
    <update id="updateCustomerInfo" parameterType="MemberDto">
        UPDATE C 
        <set>
            <if test="c_name != null">c_name = #{c_name}</if>
        </set>
        WHERE C_ID=#{m_id}
    </update>

    <!--즐겨찾는서점 리스트 가져오기-->
  	<select id="getFavStoreList" parameterType="String" resultType="MemberDto">
        <!-- 참고: 메서드 리턴타입이 List인 경우.. resultType에는 <>안의 객체타입을 적어줘야함... 그러면 알아서 메서드에서는 리스트로 반환됨 -->
        SELECT M_ID, S_STORENAME FROM FAVSTORE, M, S
        WHERE FAVS_C_ID=#{c_id} AND FAVS_S_ID=S_ID AND S_ID=M_ID
    </select>

    <!--찜한도서 리스트 가져오기-->
    <select id="getFavBookList" parameterType="String" resultType="BookDto">
        SELECT B_S_ID, B_ISBN, B_TITLE, B_AUTHOR FROM FAVBOOK, B
        WHERE FAVB_C_ID=#{c_id} AND FAVB_S_ID=B_S_ID AND FAVB_B_ISBN=B_ISBN
    </select>

</mapper>